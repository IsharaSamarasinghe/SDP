generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  userId        BigInt    @id @default(autoincrement()) @map("user_id")
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)

  firstName     String    @map("first_name") @db.VarChar(80)
  lastName      String    @map("last_name") @db.VarChar(80)
  phone         String?   @db.VarChar(32)
  organization  String?   @db.VarChar(160)
  address       String?   @db.Text
  
  country       String?   @db.VarChar(80)
  countryCode   String?   @map("country_code") @db.Char(2)

  nic           String?   @db.VarChar(20)
  studentId     String?   @map("student_id") @db.VarChar(30)
  ieeeId        String?   @map("ieee_id") @db.VarChar(30)
  
  isActive      Boolean   @default(true) @map("is_active")
  
  emailVerifiedAt DateTime? @map("email_verified_at")
  accountStatus   AccountStatus @default(PENDING_VERIFICATION) @map("account_status")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  roles               UserRole[]             @relation("UserRoles")
  userTokens          UserToken[]            @relation("UserTokens")
  sessions            Session[]              @relation("UserSessions")
  registrations       ConferenceRegistration[] @relation("UserRegistrations")
  workshops           WorkshopRegistration[] @relation("UserWorkshops")
  createdConferences  Conference[]       @relation("UserCreatedConferences")
  createdSessions     ConferenceSession[] @relation("UserCreatedSessions")
  evaluations         SessionEvaluation[] @relation("UserEvaluations")
  
  @@map("users")
  @@index([accountStatus, emailVerifiedAt])
}

enum AccountStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
}

model Role {
  roleId   BigInt @id @default(autoincrement()) @map("role_id")
  roleName String @unique @map("role_name") @db.VarChar(50)
  
  users    UserRole[]

  @@map("roles")
}

model UserRole {
  userId BigInt @map("user_id")
  roleId BigInt @map("role_id")

  user   User   @relation("UserRoles", fields: [userId], references: [userId], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model UserToken {
  tokenId    BigInt    @id @default(autoincrement()) @map("token_id")
  userId     BigInt    @map("user_id")
  tokenType  TokenType @map("token_type")
  tokenHash  String    @map("token_hash") @db.VarChar(255)
  expiresAt  DateTime  @map("expires_at")
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  user       User      @relation("UserTokens", fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, tokenType])
  @@index([expiresAt])
  @@map("user_tokens")
}

enum TokenType {
  EMAIL_VERIFY
  PASSWORD_RESET
}

model Session {
  sessionId        Bytes     @id @db.Binary(16) @map("session_id")
  userId           BigInt    @map("user_id")
  ipAddress        Bytes?    @map("ip_address") @db.VarBinary(16)
  userAgent        String?   @map("user_agent") @db.VarChar(255)
  
  refreshTokenHash String?   @map("refresh_token_hash") @db.VarChar(255)
  rotatedAt        DateTime? @map("rotated_at")

  createdAt        DateTime  @default(now()) @map("created_at")
  lastActiveAt     DateTime  @default(now()) @map("last_active_at")
  expiresAt        DateTime  @map("expires_at")
  revokedAt        DateTime? @map("revoked_at")

  user             User      @relation("UserSessions", fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([userId, revokedAt, expiresAt])
  @@map("sessions")
}

model Conference {
  conferenceId      BigInt    @id @default(autoincrement()) @map("conference_id")
  shortName         String    @map("short_name") @db.VarChar(30)
  code              String    @map("code") @db.VarChar(30)
  cmtUrl            String?   @map("cmt_url") @db.VarChar(512)
  
  name              String    @db.VarChar(200)
  year              Int       @db.UnsignedSmallInt
  theme             String?   @db.VarChar(255)
  description       String?   @db.Text
  venue             String?   @db.VarChar(150)
  
  startDate         DateTime  @map("start_date")
  endDate           DateTime  @map("end_date")
  
  registrationDeadline DateTime? @map("registration_deadline")
  earlyBirdDeadline    DateTime? @map("early_bird_deadline")

  status            ConferenceStatus @default(DRAFT)
  
  createdByUserId   BigInt    @map("created_by_user_id")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  creator           User      @relation("UserCreatedConferences", fields: [createdByUserId], references: [userId])
  
  tracks            Track[]                    @relation("ConferenceTracks")
  assets            ConferenceAsset[]          @relation("ConferenceAssets")
  publications      ConferencePublication[]    @relation("ConferencePublications")
  feeCategories     RegistrationCategory[]     @relation("ConferenceFeeCategories")
  sessions          ConferenceSession[]        @relation("ConferenceSessions")
  registrations     ConferenceRegistration[]   @relation("ConferenceRegistrations")

  @@index([status, year])
  @@map("conferences")
}

enum ConferenceStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

model Track {
  trackId      BigInt      @id @default(autoincrement()) @map("track_id")
  conferenceId BigInt      @map("conference_id")
  name         String      @db.VarChar(100)
  description  String?     @db.VarChar(255)
  
  createdAt    DateTime    @default(now()) @map("created_at")

  conference   Conference  @relation("ConferenceTracks", fields: [conferenceId], references: [conferenceId], onDelete: Cascade)
  sessions     ConferenceSession[]
  papers       Paper[]

  @@map("tracks")
}

model ConferenceAsset {
  assetId      BigInt      @id @default(autoincrement()) @map("asset_id")
  conferenceId BigInt      @map("conference_id")
  assetType    AssetType   @map("asset_type")
  title        String?     @db.VarChar(150)
  fileUrl      String      @map("file_url") @db.VarChar(512)
  
  createdAt    DateTime    @default(now()) @map("created_at")

  conference   Conference  @relation("ConferenceAssets", fields: [conferenceId], references: [conferenceId], onDelete: Cascade)

  @@map("conference_assets")
}

enum AssetType {
  FLYER
  AGENDA
  LOGO
  BANNER
  OTHER
}

model ConferencePublication {
  publicationId BigInt     @id @default(autoincrement()) @map("publication_id")
  conferenceId  BigInt     @map("conference_id")
  title         String     @db.VarChar(255)
  publisher     String?    @db.VarChar(150)
  linkUrl       String?    @map("link_url") @db.VarChar(512)
  year          Int        @db.UnsignedSmallInt

  conference    Conference @relation("ConferencePublications", fields: [conferenceId], references: [conferenceId], onDelete: Cascade)

  @@map("conference_publications")
}

model RegistrationCategory {
  categoryId   BigInt        @id @default(autoincrement()) @map("category_id")
  conferenceId BigInt        @map("conference_id")
  categoryCode String        @map("category_code") @db.VarChar(40)
  displayName  String        @map("display_name") @db.VarChar(120)
  currency     String        @db.Char(3)
  sortOrder    Int           @default(1) @map("sort_order") @db.UnsignedInt
  
  earlyBirdFee Decimal       @map("early_bird_fee") @db.Decimal(10, 2)
  standardFee  Decimal       @map("standard_fee") @db.Decimal(10, 2)
  
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  conference   Conference    @relation("ConferenceFeeCategories", fields: [conferenceId], references: [conferenceId], onDelete: Cascade)
  registrations ConferenceRegistration[]

  @@map("registration_categories")
}

model ConferenceRegistration {
  registrationId BigInt             @id @default(autoincrement()) @map("registration_id")
  conferenceId   BigInt             @map("conference_id")
  userId         BigInt             @map("user_id")
  categoryId     BigInt?            @map("category_id")
  
  status         RegistrationStatus @default(PENDING)
  
  paymentMethod  String?            @map("payment_method") @db.VarChar(50)
  paymentProofUrl String?           @map("payment_proof_url") @db.VarChar(512)
  amountPaid     Decimal            @default(0.00) @map("amount_paid") @db.Decimal(10, 2)
  paidAt         DateTime?          @map("paid_at")
  
  invoiceNumber  String?            @map("invoice_number") @db.VarChar(50)
  
  dietaryReq     String?            @map("dietary_req") @db.VarChar(100)
  tshirtSize     String?            @map("tshirt_size") @db.VarChar(10)
  
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  conference     Conference         @relation("ConferenceRegistrations", fields: [conferenceId], references: [conferenceId])
  user           User               @relation("UserRegistrations", fields: [userId], references: [userId])
  category       RegistrationCategory? @relation(fields: [categoryId], references: [categoryId])
  
  mealSelections RegistrationMeal[]

  @@unique([conferenceId, userId])
  @@map("conference_registrations")
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model MealOption {
  mealOptionId BigInt   @id @default(autoincrement()) @map("meal_option_id")
  name         String   @db.VarChar(50)
  description  String?  @db.VarChar(100)
  dateServed   DateTime? @map("date_served") @db.Date // Could be Enum for Day1/Day2 or Date
  
  selections   RegistrationMeal[]

  @@map("meal_options")
}

model RegistrationMeal {
  registrationId BigInt @map("registration_id")
  mealOptionId   BigInt @map("meal_option_id")

  registration   ConferenceRegistration @relation(fields: [registrationId], references: [registrationId], onDelete: Cascade)
  mealOption     MealOption             @relation(fields: [mealOptionId], references: [mealOptionId], onDelete: Cascade)

  @@id([registrationId, mealOptionId])
  @@map("registration_meals")
}

model Workshop {
  workshopId   BigInt   @id @default(autoincrement()) @map("workshop_id")
  title        String   @db.VarChar(200)
  description  String?  @db.Text
  resourcePerson String? @map("resource_person") @db.VarChar(100)
  venue        String?  @db.VarChar(100)
  
  startsAt     DateTime @map("starts_at")
  endsAt       DateTime @map("ends_at")
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  prices       WorkshopPrice[]
  registrations WorkshopRegistration[]

  @@map("workshops")
}

model WorkshopPrice {
  workshopPriceId BigInt   @id @default(autoincrement()) @map("workshop_price_id")
  workshopId      BigInt   @map("workshop_id")
  currency        String   @db.Char(3)
  amount          Decimal  @db.Decimal(10, 2)
  
  workshop        Workshop @relation(fields: [workshopId], references: [workshopId], onDelete: Cascade)

  @@unique([workshopId, currency])
  @@map("workshop_prices")
}

model WorkshopRegistration {
  workshopRegId BigInt             @id @default(autoincrement()) @map("workshop_reg_id")
  workshopId    BigInt             @map("workshop_id")
  userId        BigInt             @map("user_id")
  
  status        RegistrationStatus @default(PENDING)
  amountPaid    Decimal            @default(0.00) @map("amount_paid") @db.Decimal(10, 2)
  paidAt        DateTime?          @map("paid_at")
  paymentProofUrl String?          @map("payment_proof_url") @db.VarChar(512)
  
  createdAt     DateTime           @default(now()) @map("created_at")

  workshop      Workshop           @relation(fields: [workshopId], references: [workshopId])
  user          User               @relation("UserWorkshops", fields: [userId], references: [userId])

  @@unique([workshopId, userId])
  @@map("workshop_registrations")
}

model Paper {
  paperId       BigInt   @id @default(autoincrement()) @map("paper_id")
  trackId       BigInt   @map("track_id")
  title         String   @db.VarChar(255)
  abstract      String?  @db.Text
  authorsText   String   @map("authors_text") @db.VarChar(500)
  
  paperCode     String?  @map("paper_code") @db.VarChar(50)
  
  createdAt     DateTime @default(now()) @map("created_at")

  track         Track    @relation(fields: [trackId], references: [trackId])
  sessionPapers SessionPaper[]
  evaluations   SessionEvaluation[]

  @@map("papers")
}

model ConferenceSession {
  conferenceSessionId BigInt    @id @default(autoincrement()) @map("conference_session_id")
  conferenceId        BigInt    @map("conference_id")
  trackId             BigInt?   @map("track_id")
  name                String    @db.VarChar(200)
  
  startsAt            DateTime  @map("starts_at")
  endsAt              DateTime  @map("ends_at")
  venue               String?   @db.VarChar(160)
  
  createdByUserId     BigInt    @map("created_by_user_id")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  conference          Conference @relation("ConferenceSessions", fields: [conferenceId], references: [conferenceId])
  track               Track?     @relation(fields: [trackId], references: [trackId])
  creator             User       @relation("UserCreatedSessions", fields: [createdByUserId], references: [userId])
  
  criteria            SessionCriterion[]
  sessionPapers       SessionPaper[]
  evaluations         SessionEvaluation[]

  @@map("conference_sessions")
}

model SessionCriterion {
  criterionId         BigInt            @id @default(autoincrement()) @map("criterion_id")
  conferenceSessionId BigInt            @map("conference_session_id")
  name                String            @db.VarChar(100)
  maxMarks            Decimal           @map("max_marks") @db.Decimal(5, 2)
  weightage           Decimal           @default(1.00) @db.Decimal(3, 2)
  
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  session             ConferenceSession @relation(fields: [conferenceSessionId], references: [conferenceSessionId], onDelete: Cascade)
  scores              SessionEvaluationScore[]

  @@map("session_criteria")
}

model SessionPaper {
  conferenceSessionId BigInt            @map("conference_session_id")
  paperId             BigInt            @map("paper_id")
  presentationOrder   Int               @default(1) @map("presentation_order") @db.UnsignedInt
  createdAt           DateTime          @default(now()) @map("created_at")

  session             ConferenceSession @relation(fields: [conferenceSessionId], references: [conferenceSessionId])
  paper               Paper             @relation(fields: [paperId], references: [paperId])

  @@id([conferenceSessionId, paperId])
  @@map("session_papers")
}

model SessionEvaluation {
  sessionEvaluationId BigInt            @id @default(autoincrement()) @map("session_evaluation_id")
  conferenceSessionId BigInt            @map("conference_session_id")
  paperId             BigInt            @map("paper_id")
  evaluatorUserId     BigInt            @map("evaluator_user_id")
  
  totalScore          Decimal           @default(0.00) @map("total_score") @db.Decimal(6, 2)
  comments            String?           @db.Text
  
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  session             ConferenceSession @relation(fields: [conferenceSessionId], references: [conferenceSessionId])
  paper               Paper             @relation(fields: [paperId], references: [paperId])
  evaluator           User              @relation("UserEvaluations", fields: [evaluatorUserId], references: [userId])
  
  scores              SessionEvaluationScore[]

  @@unique([conferenceSessionId, paperId, evaluatorUserId])
  @@map("session_evaluations")
}

model SessionEvaluationScore {
  sessionEvaluationId BigInt           @map("session_evaluation_id")
  criterionId         BigInt           @map("criterion_id")
  score               Decimal          @default(0.00) @db.Decimal(6, 2)
  createdAt           DateTime         @default(now()) @map("created_at")

  evaluation          SessionEvaluation @relation(fields: [sessionEvaluationId], references: [sessionEvaluationId])
  criterion           SessionCriterion  @relation(fields: [criterionId], references: [criterionId])

  @@id([sessionEvaluationId, criterionId])
  @@map("session_evaluation_scores")
}
